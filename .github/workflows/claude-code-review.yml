name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, ready_for_review]
  repository_dispatch:
    types: [claude-review-requested]
  issue_comment:
    types: [created]

jobs:
  trigger-review:
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request && (contains(github.event.comment.body, '@claude') || contains(github.event.comment.body, '/review'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    steps:
      - name: Trigger PR review workflow
        uses: actions/github-script@v7
        with:
          script: |
            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // Trigger repository dispatch to re-run the review on PR head
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'claude-review-requested',
              client_payload: {
                pr_number: context.issue.number,
                head_sha: pr.head.sha,
                head_ref: pr.head.ref
              }
            });

  claude-review:
    runs-on: ubuntu-latest
    # Run if:
    # 1. PR is marked ready for review, OR
    # 2. PR opened/reopened/synchronized, OR
    # 3. Comment contains trigger phrases, OR
    # 4. Label 'trigger-ci' is added
    # (Draft check happens in steps)
    if: |
      github.event.action == 'ready_for_review' ||
      github.event_name == 'repository_dispatch' ||
      (github.event_name == 'pull_request' && contains(fromJSON('["opened", "reopened", "synchronize"]'), github.event.action)) ||
      (github.event_name == 'pull_request' && github.event.action == 'labeled' && github.event.label.name == 'trigger-ci')
    continue-on-error: true
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.head_ref || '' }}

      - name: Check if PR is draft
        id: check-draft
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            IS_DRAFT="${{ github.event.pull_request.draft }}"
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            IS_DRAFT=$(gh pr view ${{ github.event.client_payload.pr_number }} --json isDraft --jq '.isDraft')
          fi
          echo "is_draft=$IS_DRAFT" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check if commit message should trigger review
        id: check-commit
        if: github.event_name == 'pull_request' && github.event.action == 'synchronize' && steps.check-draft.outputs.is_draft != 'true'
        run: |
          COMMIT_SHA="${{ github.event.after }}"
          COMMIT_MSG=$(git log --format=%B -n 1 $COMMIT_SHA)
          if [[ "$COMMIT_MSG" == *"@claude"* ]] || [[ "$COMMIT_MSG" == *"/review"* ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code Review
        if: |
          steps.check-draft.outputs.is_draft != 'true' &&
          (github.event_name == 'repository_dispatch' || github.event.action != 'synchronize' || steps.check-commit.outputs.should_run == 'true')
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true # ‚ú® Enables tracking comments

          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ steps.pr-info.outputs.pr_number }}

            Review a PR

            IMPORTANT: Post your review with this exact header at the top:
            ## üîç General Code Review (Linus & Cassidy)

            You are an expert code reviewer. You have two personalities:
            - A grumpy senior engineer, very technical and precise. His name is Linus.
            - An optimistic senior engineer, pragmatic, encouraging. Her name is Cassidy.

            You will review the pull request twice: once with each personality. Stay in-character for both personas. Balance friendliness (Cassidy) and bluntness (Linus), but ensure the final consensus is clear and useful. At the end you return a full report with the findings of each reviewer, and a consensus.

            **Response Format:**

            Use GitHub spoilers (collapsible sections) to organize your review and keep it concise:

            <details>
            <summary><b>üìã Context</b></summary>

            - Overview of what the PR does
            - Context from Jira tickets/Confluence docs (if applicable)
            - Files changed summary

            </details>

            <details>
            <summary><b>üòä Cassidy's Review (Optimistic & Constructive)</b></summary>

            - Positive aspects and good practices
            - Constructive suggestions for improvements
            - Encouraging feedback

            </details>

            <details>
            <summary><b>üò§ Linus' Review (Blunt & Technical)</b></summary>

            - Critical technical analysis
            - Potential issues and risks
            - Harsh but fair critique

            </details>

            **üéØ Consensus Summary:** A concise, actionable plan that combines both perspectives. 

            Follow these steps:

            If no PR number is provided in the args, use Bash("gh pr list") to show open PRs
            If a PR number is provided, use Bash("gh pr view ") to get PR details
            Use Bash("gh pr diff ") to get the diff

            If the PR description links to Jira tickets, Confluence docs, use the Atlassian MCP to fetch their contents. This will help provide more context and requirements.

            Analyze the changes and provide a thorough code review that includes:
            - Overview of what the PR does
            - Analysis of code quality and style
            - Specific suggestions for improvements
            - Any potential issues or risks

            Keep your review concise but thorough. Focus on:
            - Code correctness, major bugs or logic issues
            - Code readability and structure 
            - Following project conventions
            - Performance and efficiency
            - Maintainability and scalability
            - Security considerations
            - Test coverage
            Format your review with clear sections and bullet points.

            Note: The PR branch is already checked out in the current working directory.
            Use `gh pr comment` for top-level feedback.

          # Optional: Use sticky comments to make Claude reuse the same comment on subsequent pushes to the same PR
          use_sticky_comment: true
          comment_tag: "claude-code-review"
          claude_args: |
            --allowedTools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"
